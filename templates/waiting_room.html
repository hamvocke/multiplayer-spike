<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Waiting Room</title>
</head>
<body>
    <h1 data-slug={{game_slug}}>Game: {{ game_slug }}</h1>
    <h2>Players</h2>
    <ul class="players"></ul>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/3.0.1/socket.io.min.js" crossorigin="anonymous"></script>
    <script>
        function generatePlayerName() {
            return `player-${Math.random()}`;
        }

        function uuidv4() {
            return ([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g, c =>
                (c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4).toString(16)
            );
        }

        // TODO: store guid in cookie

        let socket = io();
        let game_slug = document.querySelector("h1").dataset["slug"];
        let joinMessage = {
                "player": {
                    "guid": uuidv4(),
                    "name": generatePlayerName()
                },
                "game_slug": game_slug 
            }

        socket.emit('join', JSON.stringify(joinMessage));

        socket.on('joined', function(msg) {
            console.log("joined", msg)
            let data = JSON.parse(msg);
            for(index in data) {
                let player = data[index];
                if (!player) continue;
                let newItem = document.createElement("li");
                newItem.dataset["guid"] = player.guid;
                newItem.innerText = `${player.name} (${player.state})`;
                document.querySelector(".players").appendChild(newItem)
            }
        });

        socket.on('left', function(msg) {
            console.log("left", msg)
            let data = JSON.parse(msg);
            for(index in data) {
                let player = data[index];
                if (!player) continue;
                let listItem = document.querySelector(`li[data-guid='${player.guid}'`);
                listItem.innerText = `${player.name} (${player.state})`;
            }
        });
    </script>
</body>
</html>